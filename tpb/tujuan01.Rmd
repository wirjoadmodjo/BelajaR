---
title: "Tujuan 01"
output: html_document
---

```{r setup & library, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load library
library(foreign)
#library(haven)
library(readxl)
library(data.table)
library(Hmisc)
library(openxlsx)
```
```{r config, include=FALSE, echo=FALSE}
dir = "tpb"
dir_root = getwd()
dir_root = substr(dir_root, 1, nchar(dir_root) - nchar(dir) - 1)

# direktori dan nama file input
## path file rawdata ssn
ssn_path = c(
   "ssnind_2015", 
   "X:/Documents/Garapan/pabrik angka/rawdata/Susenas2015/KOR15IND_DOB.sav",
   "ssnind_2016", 
   "X:/Documents/Garapan/pabrik angka/rawdata/Susenas201603/kor16ind_revisi_14122016.dbf"
)

#ssn_dir = "/media/DataNTFS/PabrikAngka/rawdata/Susenas201603"
#ssn_dir = "E:/PabrikAngka/rawdata/Susenas201603"
#ssn_dir = "X:/Documents/Garapan/pabrik angka/rawdata/Susenas201603"
#ssn_ind = "kor16ind_revisi_14122016.dbf"
#ssn_kor = ""

ssn_var = paste(dir_root, "_include/varssn.xls", sep = "/")

## baca matrik variabel R-SSN
varssn_IND = read_xls(ssn_var, sheet = "individu")

## matrik var ssn
varssn = "V2015"
for (var_r in varssn_IND$R) {
  assign(var_r, varssn_IND[[varssn]][which(varssn_IND$R == var_r)])
}

## matrik kode provinsi
kodeprov = setDT(read_xls(ssn_var, sheet = "kodeprovinsi"))
set2key(kodeprov, "prov")

# read rawdata
for (i in seq(from = 1, to = length(ssn_path), 2)) {
   ssn = ssn_path[i]
   temp_split = unlist(strsplit(ssn_path[i+1], ".", fixed = TRUE))
   ext = temp_split[2]
   
   if (ext == "dbf") {
      assign(paste("dt", ssn, sep = ""), setDT(read.dbf(ssn_path[i+1])))
   } 
   
   else if (ext == "sav") {
      assign(paste("dt", ssn, sep = ""), setDT(read.spss(ssn_path[i+1])))
   }
}

## rawdata yang dipakai
dtind = setDT(read.spss("X:/Documents/Garapan/pabrik angka/rawdata/Susenas2015/KOR15IND_DOB.sav"))

```
```{r user function}



```

### Indikator 1.4.1.(a)
#### Persentase perempuan pernah kawin umur 15-49 tahun 
#### yang proses melahirkan terakhirnya di fasilitas kesehatan.
```{r indikator 1.4.1.(a)}
## set key berdasarkan agregasi data untuk mempercepat komputasi
setkeyv(dtind, c(prov, kota_desa))

# hitung batas pendapatann 40%
exp_cap_40 = wtd.quantile(dtind[[expcap]], 
                          weights = dtind[[weight]],
                          probs = 0.4, na.rm = TRUE)


##########################################################################
# indikator 1.4.1.(a)
# -------------------
# 
# RUMUS ******************************************************************
#                 JPSalifaskes
# PSalifaskes = ---------------- X 100%
#                  JP15-49th        
#
# Keterangan
# PSalifaskes  = Persentase perempuan pernah kawin umur 15-49 tahun 
#                yang proses melahirkan terakhirnya di fasilitas kesehatan
# JPSalifaskes = Jumlah perempuan pernah kawin umur 15-49 tahun yang 
#                proses melahirkan terakhirnya di fasilitas kesehatan
#                (penduduk 40% terbawah/berpendapatan terendah)
# JP15-49      = Jumlah perempuan pernah kawin umur 15-49 tahun 
#                yang pernah melakukan persalinan
#                (penduduk 40% terbawah/berpendapatan terendah)
#************************************************************************

## nilai absolut dan agregasi
dt_temp = dtind[
   ## filter jenis kelamin perempuan
   get(jenis_kel) == 2 &
   
   ## filter status perkawinan pernah kawin
   get(stat_kawin) >= 2 &
      
   ## filter umur 15 - 49
   get(umur) >= 15 & get(umur) <= 49 &
   
   ## filter pernah melahirkan lahir hidup 
   get(lahir_hidup_2th) == 1 &
      
   ## filter pendapatan 40%
   get(expcap) <= exp_cap_40,
      
   .( 
      prov = get(prov),
      kota_desa = get(kota_desa),
      JPSalifaskes = ifelse(get(tempat_salin) <= 3, get(weight), 0),
      JP15_49 = get(weight)
   )
]

## persentase by prov dan angka nasional
dt_prov = cube(dt_temp, 
     .(PSalifaskes = round(sum(JPSalifaskes) * 100 /sum(JP15_49), 2)), 
     by=c("prov"))

dt_prov = merge(dt_prov, kodeprov, all.x = TRUE)
dt_prov[is.na(Provinsi), Provinsi := "Indonesia"]


## persentase by kota-desa
dt_kota_desa = dt_temp[,
   .(PSalifaskes = round(sum(JPSalifaskes) * 100 /sum(JP15_49), 2)),
   by = list(kota_desa)
]
```

### Indikator 1.4.1.(b)
#### Persentase anak umur 12-23 bulan 
#### yang menerima imunisasi dasar lengkap
```{r indikator 1.4.1.(b)}
## set key berdasarkan agregasi data untuk mempercepat komputasi
setkeyv(dtind, c(prov, kota_desa, kota_desa, jenis_kel))

##########################################################################
# indikator 1.4.1.(b)
# -------------------
# 
# RUMUS ******************************************************************
#                 JPSalifaskes
# PSalifaskes = ---------------- X 100%
#                  JP15-49th        
#
# Keterangan
# PIDL         = Persentase anak umur 12-23 bulan 
#                yang menerima imunisasi dasar lengkap
# JAIDL        = Banyaknya anak umur 12-23 bulan 
#                yang telah menerima imunisasi dasar lengkap 
#                pada periode waktu tertentu
#                (penduduk 40% terbawah/berpendapatan terendah)
# JA12-23bln   = Jumlah anak umur 12-23 bulan pada periode waktu yang sama
#                (penduduk 40% terbawah/berpendapatan terendah)
#************************************************************************

dt_temp = dtind[
   ## filter balita umur 12-23 bulan
   get(umur_balita) >= 12 & get(umur_balita) <= 23 &
      
   ## filter pendapatan 40%
   get(expcap) <= exp_cap_40,
   
   .(
      prov = get(prov),
      kota_desa = get(kota_desa),
      jenis_kel = get(jenis_kel),
      JAIDL = ifelse(
         ## imunisai DPT 3x
         get(imun_dpt1) > 0 & get(imun_dpt2) > 0 & get(imun_dpt3) > 0 &
         
         ## versi polio 3x
         (
            ## polio 1, 2, 3
            (get(imun_polio1) > 0 & get(imun_polio2) > 0 & get(imun_polio3) > 0) |
            ## polio 1, 3, 4
            (get(imun_polio1) > 0 & get(imun_polio3) > 0 & get(imun_polio4) > 0) |
            ## polio 2, 3, 4
            (get(imun_polio2) > 0 & get(imun_polio3) > 0 & get(imun_polio4) > 0)
         ) &
      
         ## imunisasi Polio 4x
         #get(imun_polio1) > 0 & get(imun_polio2) > 0 & get(imun_polio3) > 0 & get(imun_polio4) > 0 &
         ## imunisasi campak & bcg
         get(imun_campak) > 0  & get(imun_campak) > 0 &
            
         ## versi hepatitis 3x
         (
            ## 1, 2, 3
            (get(imun_hb1) > 0 & get(imun_hb2) > 0 & get(imun_hb3) > 0) |
            ## 1, 3, 4
            (get(imun_hb1) > 0 & get(imun_hb3) > 0 & get(imun_hb4) > 0) |
            ## 2, 3, 4
            (get(imun_hb2) > 0 & get(imun_hb3) > 0 & get(imun_hb4) > 0)
         ), 
            
         ## imunisasi hepatitis B 4x
         #get(imun_hb1) > 0 & get(imun_hb2) > 0 & get(imun_hb3) > 0 & get(imun_hb4) > 0,
         
         get(weight), 0
      ),
      JA12_23bln = get(weight)
   )
]

## replace NA value
dt_temp[is.na(JAIDL), JAIDL := 0]

## persentase by prov dan angka nasional
dt_prov = cube(dt_temp, 
     .(PIDL = round(sum(JAIDL) * 100 /sum(JA12_23bln), 2)), 
     by=c("prov"))

dt_prov = merge(dt_prov, kodeprov, all.x = TRUE)
dt_prov[is.na(Provinsi), Provinsi := "Indonesia"]

## persentase by kota-desa
dt_kota_desa = dt_temp[,
   .(PIDL = round(sum(JAIDL) * 100 /sum(JA12_23bln), 2)),
   by = list(kota_desa)
]

## persentase by jenis kelamin
dt_jenis_kel = dt_temp[,
   .(PIDL = round(sum(JAIDL) * 100 /sum(JA12_23bln), 2)),
   by = list(jenis_kel)
]
```




